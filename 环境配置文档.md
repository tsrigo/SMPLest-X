# SMPLest-X 环境配置文档

本文档详细记录了 SMPLest-X 项目的环境配置过程，便于其他人复现。

## 目录
- [系统要求](#系统要求)
- [环境配置步骤](#环境配置步骤)
- [验证测试](#验证测试)
- [常见问题](#常见问题)

---

## 系统要求

### 硬件要求
- **GPU**: NVIDIA GPU（支持 CUDA 11.3）
- **显存**: 建议至少 8GB（训练需要更多）
- **内存**: 建议至少 16GB

### 软件要求
- **操作系统**: Linux (Ubuntu 18.04+ 推荐)
- **Conda**: Miniconda 或 Anaconda
- **CUDA**: 11.3 (通过 conda 安装)
- **Python**: 3.8

---

## 环境配置步骤

### 步骤 1: 创建 Conda 环境

创建一个名为 `smplestx` 的 Python 3.8 环境：

```bash
conda create -n smplestx python=3.8 -y
```

**预期输出**:
```
Collecting package metadata (repodata.json): done
Solving environment: done
...
# To activate this environment, use
#     $ conda activate smplestx
```

---

### 步骤 2: 安装 PyTorch 和 CUDA

安装 PyTorch 1.12.0 及其相关组件，包括 CUDA 11.3 工具包：

```bash
conda install -n smplestx pytorch==1.12.0 torchvision==0.13.0 torchaudio==0.12.0 cudatoolkit=11.3 -c pytorch -y
```

**说明**:
- 这个命令会安装约 2.15GB 的包
- 包括 PyTorch、torchvision、torchaudio 和 CUDA toolkit
- 安装时间取决于网络速度，通常需要 5-15 分钟

**预期输出**:
```
Downloading and Extracting Packages
pytorch-1.12.0       | 1.20 GB   | ########## | 100%
cudatoolkit-11.3.1   | 549.3 MB  | ########## | 100%
...
Executing transaction: done
```

---

### 步骤 3: 安装项目依赖

进入项目目录并安装 requirements.txt 中的依赖：

```bash
cd /path/to/SMPLest-X
conda run -n smplestx pip install -r requirements.txt
```

**requirements.txt 内容**:
```
numpy==1.23.1
smplx==0.1.28
tqdm==4.67.1
opencv-python==4.11.0.86
chumpy==0.70
trimesh==4.6.2
pyrender==0.1.45
matplotlib==3.7.5
json_tricks==3.17.3
einops==0.8.1
timm==1.0.14
ultralytics==8.3.75
pyopengl
```

**预期输出**:
```
Collecting numpy==1.23.1
  Downloading numpy-1.23.1-...
...
Successfully installed chumpy-0.70 contourpy-1.1.1 cycler-0.12.1 einops-0.8.1 ...
```

---

### 步骤 4: 安装 Mesa 库（用于无头渲染）

安装 mesalib 以支持无显示器环境下的 OpenGL 渲染：

```bash
conda install -n smplestx -c conda-forge mesalib -y
```

**说明**:
- mesalib 提供了 OSMesa (Off-Screen Mesa) 支持
- 允许在没有显示器的服务器上进行 3D 渲染
- 对于 pyrender 的正常工作是必需的

**预期输出**:
```
Collecting package metadata (repodata.json): done
Solving environment: done
...
Executing transaction: done
```

---

## 验证测试

### 基础验证

激活环境并验证安装：

```bash
conda activate smplestx
```

运行以下 Python 命令验证核心库：

```bash
python -c "import torch; import smplx; import cv2; import trimesh; print('PyTorch version:', torch.__version__); print('CUDA available:', torch.cuda.is_available()); print('CUDA device count:', torch.cuda.device_count()); print('All imports successful!')"
```

**预期输出**:
```
PyTorch version: 1.12.0
CUDA available: True
CUDA device count: 4
All imports successful!
```

**说明**:
- `CUDA available: True` 表示 CUDA 可用
- `CUDA device count` 显示可用的 GPU 数量（根据你的硬件配置）
- 如果 `CUDA available: False`，请检查 NVIDIA 驱动是否正确安装

---

### 详细版本检查

检查所有关键依赖的版本：

```bash
python -c "
import torch
import numpy as np
import cv2
import trimesh
import smplx
import timm
import ultralytics

print('=' * 50)
print('环境配置信息')
print('=' * 50)
print(f'PyTorch: {torch.__version__}')
print(f'NumPy: {np.__version__}')
print(f'OpenCV: {cv2.__version__}')
print(f'Trimesh: {trimesh.__version__}')
print(f'SMPL-X: {smplx.__version__}')
print(f'Timm: {timm.__version__}')
print(f'Ultralytics: {ultralytics.__version__}')
print('=' * 50)
print(f'CUDA 可用: {torch.cuda.is_available()}')
if torch.cuda.is_available():
    print(f'CUDA 版本: {torch.version.cuda}')
    print(f'GPU 数量: {torch.cuda.device_count()}')
    for i in range(torch.cuda.device_count()):
        print(f'GPU {i}: {torch.cuda.get_device_name(i)}')
print('=' * 50)
"
```

---

## 常见问题

### 1. CUDA 不可用 (CUDA available: False)

**问题**: 运行验证时显示 `CUDA available: False`

**可能原因**:
- NVIDIA 驱动未安装或版本不兼容
- CUDA toolkit 版本与驱动不匹配

**解决方案**:
```bash
# 检查 NVIDIA 驱动
nvidia-smi

# 如果命令不存在或报错，需要安装 NVIDIA 驱动
# Ubuntu 系统可以使用：
sudo apt-get update
sudo apt-get install nvidia-driver-470  # 或其他兼容版本
```

---

### 2. PyOpenGL 相关错误

**问题**: 运行推理时出现 `AttributeError: 'NoneType' object has no attribute 'glGetError'`

**可能原因**:
- 系统缺少 OpenGL 相关库
- 在无显示器的服务器上运行

**解决方案**:
```bash
# 安装 osmesa 库（需要 sudo 权限）
sudo apt-get update
sudo apt-get install python-opengl -y
sudo apt-get install libosmesa6 -y

# 更新 pyopengl 版本
conda activate smplestx
pip install pyopengl==3.1.4
```

---

### 3. NumPy 版本冲突

**问题**: 出现 NumPy 版本不兼容的警告

**解决方案**:
```bash
conda activate smplestx
pip install numpy==1.23.1 --force-reinstall
```

---

### 4. 训练时出现 ZeroDivisionError

**问题**: 训练时出现 `ZeroDivisionError: integer division or modulo by zero`

**可能原因**:
- 没有检测到 GPU
- GPU 数量配置不正确

**解决方案**:
```bash
# 确认 GPU 可用
python -c "import torch; print('GPU count:', torch.cuda.device_count())"

# 如果 GPU 数量为 0，检查 CUDA 和驱动安装
```

---

## 项目准备

环境配置完成后，还需要准备以下内容才能运行项目：

### 1. 下载预训练模型

从 [HuggingFace](https://huggingface.co/waanqii/SMPLest-X/tree/main) 下载 SMPLest-X-Huge 模型：

```bash
# 创建目录
mkdir -p pretrained_models/smplest_x_h

# 下载模型文件（约 8.2GB）
# 需要手动从 HuggingFace 下载或使用 git-lfs
```

将下载的文件放置在：
- `pretrained_models/smplest_x_h/smplest_x_h.pth.tar`
- `pretrained_models/smplest_x_h/config_base.py`

---

### 2. 下载人体模型文件

需要下载 SMPL 和 SMPL-X 模型文件：

- **SMPL-X**: 访问 [SMPL-X 官网](https://smpl-x.is.tue.mpg.de/) 注册并下载
- **SMPL**: 访问 [SMPL 官网](https://smpl.is.tue.mpg.de/) 注册并下载

将模型文件放置在 `human_models/human_model_files/` 目录下。

---

### 3. 准备训练数据（仅训练需要）

如果需要训练模型，请参考 [humandata_prep/README.md](humandata_prep/README.md) 准备 HumanData 格式的数据。

---

## 快速开始

### 推理示例

```bash
# 激活环境
conda activate smplestx

# 进入项目目录
cd /path/to/SMPLest-X

# 运行推理（假设有 test_video.mp4 在 demo 目录）
sh scripts/inference.sh smplest_x_h test_video.mp4 30
```

---

### 训练示例

```bash
# 使用 16 个 GPU 训练 SMPLest-X-H
bash scripts/train.sh smplest_x_h 16 config_smplest_x_h.py
```

---

### 测试示例

```bash
# 在 SynHand 数据集上测试模型
sh scripts/test.sh SynHand smplest_x_h 5
```

---

## 环境信息总结

### 已安装的关键依赖版本

| 包名 | 版本 |
|------|------|
| Python | 3.8 |
| PyTorch | 1.12.0 |
| torchvision | 0.13.0 |
| CUDA Toolkit | 11.3 |
| NumPy | 1.23.1 |
| OpenCV | 4.11.0.86 |
| SMPL-X | 0.1.28 |
| Trimesh | 4.6.2 |
| PyRender | 0.1.45 |
| Matplotlib | 3.7.5 |
| Timm | 1.0.14 |
| Ultralytics | 8.3.75 |

---

## 参考资源

- **项目主页**: https://caizhongang.github.io/projects/SMPLer-X/
- **论文**: https://arxiv.org/abs/2501.09782
- **GitHub**: https://github.com/caizhongang/SMPLer-X
- **预训练模型**: https://huggingface.co/waanqii/SMPLest-X

---

## 更新日志

- **2025-12-26**: 初始版本，完成基础环境配置文档

---

**文档创建时间**: 2025-12-26
**环境配置人**: Claude Code
**测试状态**: ✅ 环境配置成功，CUDA 可用，检测到 4 个 GPU
